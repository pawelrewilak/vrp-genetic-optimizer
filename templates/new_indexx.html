<!DOCTYPE html>
<html lang="pl">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<head>
    <meta charset="UTF-8">
    <title>Dashboard VRP</title>
    <style>
        body {
            background-color: #c5c5dc;
            font-family: 'Segoe UI', sans-serif;
            margin: 0;
            height: 100vh;
            display: flex;
            overflow: hidden;
        }

        .left-panel {
            width: 55%;
            height: 100vh;
            overflow-y: auto; /* Tylko lewa strona się przewija */
            padding: 20px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            gap: 20px; /* Odstęp między kartami */
        }

        /* --- PRAWY PANEL (Mapa) --- */
        .right-panel {
            width: 45%;
            height: 100vh;
            background-color: #e0e0eb; /* Nieco inny odcień dla oddzielenia */
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        /* --- KARTY (Białe pudełka) --- */
        .card {
            background-color: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            text-align: center;
        }

        h2 { margin-top: 0; color: #333; font-size: 22px; border-bottom: 2px solid #f0f0f0; padding-bottom: 10px; margin-bottom: 20px;}
        h3 { margin-top: 0; color: #555; font-size: 18px; margin-bottom: 15px; }

        /* --- STYLE FORMULARZY (Wspólne) --- */
        label {
            display: block;
            text-align: left;
            margin-bottom: 5px;
            margin-top: 10px;
            color: #555;
            font-weight: 600;
            font-size: 13px;
        }

        input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 14px;
            background-color: #fafafa;
        }
        input:focus { outline: 2px solid #007bff; border-color: transparent; background: white; }
        input[readonly] { background-color: #e9ecef; color: #666; cursor: not-allowed; }

        /* Grid dla inputów (np. X i Y obok siebie) */
        .input-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        /* --- PRZYCISKI --- */
        button {
            width: 100%;
            padding: 12px;
            margin-top: 15px;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: 0.2s;
        }
        .btn-blue { background-color: #007bff; }
        .btn-blue:hover { background-color: #0056b3; }
        
        .btn-green { background-color: #28a745; margin-top: 25px;}
        .btn-red { background-color: #c80000; margin-top: 25px;}
        .btn-green:hover { background-color: #218838; }

        /* --- RADIO BUTTONY (Mutacja) --- */
        .radio-container {
            display: flex;
            justify-content: space-between;
            gap: 5px;
            margin-bottom: 10px;
        }
        .radio-container input[type="radio"] { display: none; }
        .radio-container label {
            flex: 1;
            padding: 8px 4px;
            background-color: #fafafa;
            border: 1px solid #ddd;
            border-radius: 6px;
            text-align: center;
            cursor: pointer;
            font-size: 12px;
            margin: 0;
        }
        .radio-container input[type="radio"]:checked + label {
            background-color: #007bff;
            color: white;
            border-color: #007bff;
        }

        /* --- LISTA SZKÓŁ (Scrollowalna tabela) --- */
        .scrollable-list {
            max-height: 200px; /* Wysokość listy zanim pojawi się pasek przewijania */
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 6px;
            margin-top: 10px;
        }
        table { width: 100%; border-collapse: collapse; font-size: 12px; }
        th { background: #f8f9fa; position: sticky; top: 0; padding: 8px; text-align: left; border-bottom: 2px solid #ddd; }
        td { padding: 8px; border-bottom: 1px solid #eee; text-align: left;}
        tr:nth-child(even) { background-color: #f9f9f9; }

        /* --- MAPA --- */
        canvas {
            background-color: white;
            border: 3px solid #333;
            border-radius: 8px;
            cursor: crosshair;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        .modal {
            display: none;
            position: fixed; 
            z-index: 1000; 
            left: 0; top: 0;
            width: 100%; height: 100%; 
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
            justify-content: center; align-items: center;
        }
        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 12px;
            width: 700px; height: 500px;
            box-shadow: 0 5px 30px rgba(0,0,0,0.3);
            position: relative;
            display: flex; flex-direction: column;
        }
        .close-btn {
            position: absolute;
            top: 10px; right: 15px;
            font-size: 24px; font-weight: bold; color: #333;
            cursor: pointer;
        }


    </style>
</head>
<body>

    <div class="left-panel">
        
        <div class="card">
            <h2>1. Konfiguracja Algorytmu</h2>
            
            <div class="input-grid">
                <div>
                    <label>Populacja:</label>
                    <input type="number" id="pop_size" value="60">
                </div>
                <div>
                    <label>Iteracje:</label>
                    <input type="number" id="generations" value="250">
                </div>
            </div>

            <label>Metoda mutacji:</label>
            <div class="radio-container">
                <input type="radio" id="m1" name="tryb_mutacji" value="swap" checked>
                <label for="m1">Swap</label>
                <input type="radio" id="m2" name="tryb_mutacji" value="inv">
                <label for="m2">Inv</label>
                <input type="radio" id="m3" name="tryb_mutacji" value="ins">
                <label for="m3">Ins</label>
                <input type="radio" id="m4" name="tryb_mutacji" value="scr">
                <label for="m4">Scr</label>
                <input type="radio" id="m5" name="tryb_mutacji" value="hybrid">
                <label for="m5">Hyb</label>
            </div>

            

            <label>Metoda krzyżowania</label>
            <div class="radio-container">

                <input type="radio" id="k1" name="tryb_krzyzowania" value="order" checked>
                <label for="k1">Order</label>
                <input type="radio" id="k2" name="tryb_krzyzowania" value="erx">
                <label for="k2">ERX (Edge Recombination)</label>

            </div>

            <label>Szanse mutacji:</label>
            <div class="input-grid">
                <div><label style="margin:0; font-size:11px">Swap</label><input type="number" id="mut_rate1" value="0.55" step="0.01"></div>
                <div><label style="margin:0; font-size:11px">Inv</label><input type="number" id="mut_rate2" value="0.55" step="0.01"></div>
                <div><label style="margin:0; font-size:11px">Ins</label><input type="number" id="mut_rate3" value="0.55" step="0.01"></div>
                <div><label style="margin:0; font-size:11px">Scr</label><input type="number" id="mut_rate4" value="0.55" step="0.01"></div>
            </div>
            
            <button class="btn-blue" id="btn-zatwierdz">Zatwierdź i Oblicz VRP</button>
        </div>

        <div class="card">
            <h2>2. Dodaj Nową Szkołę</h2>
            
            <div class="input-grid">
                <div>
                    <label>ID (Auto):</label>
                    <input type="number" id="new_id" value="1" readonly>
                </div>
                <div>
                    <label>Zysk:</label>
                    <input type="number" id="new_profit" value="10">
                </div>
            </div>

            <label>Lokalizacja (X, Y):</label>
            <div class="input-grid">
                <input type="number" id="new_x" placeholder="X (0-600)">
                <input type="number" id="new_y" placeholder="Y (0-600)">
            </div>

            <label>Okno czasowe (Start - Koniec):</label>
            <div class="input-grid">
                <input type="time" id="new_tmin" value="08:00">
                <input type="time" id="new_tmax" value="16:00">
            </div>

            <label>Czas serwisu (min):</label>
            <input type="number" id="service_time" value="10">

            <button class="btn-green" id="btn-dodaj">+ Dodaj szkołę do mapy</button>

        </div>

        <div class="card">
            <h2>3. Usuń Szkołę</h2>

            <label> Id szkoły do usuniecia</label>
            <input type="number" id="id_delete">
            <button class="btn-red" id="btn-usun">Usuń</button>
        </div>

        <div class="card" style="background-color: #e8f4fd;"> <h2>Szybki Generator</h2>
            <label>Ilość szkół do wygenerowania</label>
            <div class="input-grid" >
                    <input type="number" id="num_generate">
                    <button class="btn-blue" id="btn-random" style="margin-top:0;">⚡ Generuj losowo</button>
            </div>
        </div>

        <div class="card">
            <h3>Aktualna lista szkół</h3>
            <div class="scrollable-list">
                <table id="tabela-szkol">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>X, Y</th>
                            <th>Okno</th>
                            <th>Zysk</th>
                        </tr>
                    </thead>
                    <tbody>
                        </tbody>
                </table>
            </div>
        </div>

    </div>

    <div class="right-panel">
        <h2 style="border:none; margin-bottom:10px;">Podgląd Mapy (600x600)</h2>
        <canvas id="mojapapa" width="600" height="600"></canvas>
        <div id="licznik_szkol" style="margin-top:10px; font-weight:bold;">Liczba szkół: 0</div>
    </div>

    <div id="modalWykres" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="zamknijWykres()">&times;</span>
            <h2 style="margin-top:0; text-align: center;">Postęp Ewolucji</h2>
            <canvas id="wykresCanvas"></canvas>
        </div>
    </div>


    <script>
        // --- KONFIGURACJA ---
        const canvas = document.getElementById('mojapapa');
        const ctx = canvas.getContext('2d');
        
        const ROZMIAR_CANVAS = 600;  
        const MAX_WSPOLRZEDNA = 600; 
        const SKALA = ROZMIAR_CANVAS / MAX_WSPOLRZEDNA;
        const GODZINA_STARTU = 8; 
        const MINUTY_STARTU = GODZINA_STARTU * 60; 

        let listaSzkol = [];

        // --- ZMIENNE POMOCNICZE DO WIZUALIZACJI ---
    let wykresInstancja = null;
    const KOLORY_TRAS = ["#FF0000", "#008000", "#0000FF", "#FFA500", "#800080", "#00CED1", "#FF1493"];

    // --- FUNKCJA: Rysowanie tras na mapie ---
    function rysujTrasy(trasy) {
        // 1. Czyścimy mapę i rysujemy punkty od nowa
        ctx.clearRect(0, 0, ROZMIAR_CANVAS, ROZMIAR_CANVAS);
        rysujPunkt(300, 30, "red", 8); // Rysuj bazę (Depot) - Pamiętaj o współrzędnych z server.py!
        
        listaSzkol.forEach(s => rysujPunkt(s.x, s.y, "#007bff"));

        // 2. Rysujemy linie
        trasy.forEach((trasa, index) => {
            ctx.beginPath();
            ctx.lineWidth = 2;
            ctx.strokeStyle = KOLORY_TRAS[index % KOLORY_TRAS.length]; // Cykliczne kolory

            // Startujemy od bazy (ID 0) -> (300, 30)
            let startX = 300; 
            let startY = ROZMIAR_CANVAS - 30;
            ctx.moveTo(startX, startY);

            trasa.forEach(idSzkoly => {
                if (idSzkoly === 0) {
                    // Powrót do bazy
                    ctx.lineTo(startX, startY);
                } else {
                    // Szukamy szkoły w JS
                    let szkola = listaSzkol.find(s => s.id === idSzkoly);
                    if (szkola) {
                        let px = szkola.x;
                        let py = ROZMIAR_CANVAS - szkola.y;
                        ctx.lineTo(px, py);
                    }
                }
            });
            ctx.stroke();
        });
    }

    // --- FUNKCJA: Pokazywanie wykresu ---
    function pokazWykres(historia, historiaBest) {
        const modal = document.getElementById('modalWykres');
        const ctxWykres = document.getElementById('wykresCanvas').getContext('2d');
        
        modal.style.display = 'flex';

        if (wykresInstancja) wykresInstancja.destroy();

        const labels = historia.map((_, i) => i + 1);

        wykresInstancja = new Chart(ctxWykres, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Rekord Globalny',
                        data: historiaBest,
                        borderColor: '#28a745',
                        borderWidth: 2,
                        tension: 0,
                        pointRadius: 0
                    },
                    {
                        label: 'Populacja',
                        data: historia,
                        borderColor: '#007bff',
                        borderWidth: 1,
                        borderDash: [5, 5],
                        pointRadius: 0
                    }
                ]
            },
            options: { 
                responsive: true, 
                maintainAspectRatio: false,
                scales: {
                    x: { title: { display: true, text: 'Generacja' } },
                    y: { title: { display: true, text: 'Zysk (Fitness)' } }
                }
            }
        });
    }

    function zamknijWykres() {
        document.getElementById('modalWykres').style.display = 'none';
    }

        // --- FUNKCJE POMOCNICZE ---
        function czasNaMinuty(czasString) {
            if (!czasString) return 0;
            let czesci = czasString.split(':');
            let h = parseInt(czesci[0]);
            let m = parseInt(czesci[1]);
            return (h * 60) + m - MINUTY_STARTU;
        }

        function rysujPunkt(x, y, kolor, rozmiar = 5) {
            let pixelX = x;
            let pixelY = ROZMIAR_CANVAS - y; // Odwracamy Y

            ctx.beginPath();
            ctx.arc(pixelX, pixelY, rozmiar, 0, Math.PI * 2);
            ctx.fillStyle = kolor;
            ctx.fill();
            ctx.strokeStyle = "black";
            ctx.lineWidth = 1;
            ctx.stroke();
            
            // Opcjonalnie: Numer szkoły na mapie
            if (kolor === "#007bff") { // Jeśli to szkoła (niebieska)
                ctx.fillStyle = "white";
                ctx.font = "10px Arial";
                // ctx.fillText("x", pixelX, pixelY); // Można dodać tekst
            }
        }

        function dodajWierszDoTabeli(szkola) {
            const tabela = document.getElementById('tabela-szkol').getElementsByTagName('tbody')[0];
            const nowyWiersz = tabela.insertRow();
            
            // Komórka ID
            const komorkaId = nowyWiersz.insertCell(0);
            komorkaId.innerText = szkola.id;

            // Komórka Współrzędne
            const komorkaXY = nowyWiersz.insertCell(1);
            komorkaXY.innerText = `(${szkola.x}, ${szkola.y})`;

            // Komórka Okno (pobieramy tekst z inputów, który zapisaliśmy w display_time)
            const komorkaOkno = nowyWiersz.insertCell(2);
            komorkaOkno.innerText = `${szkola.display_time[0]} - ${szkola.display_time[1]}`;

            // Komórka Zysk
            const komorkaZysk = nowyWiersz.insertCell(3);
            komorkaZysk.innerText = szkola.profit;
        }

        // --- INICJALIZACJA ---
        console.log("Dashboard VRP Gotowy.");
        // Rysujemy BAZĘ na środku na dole (300 , 30)
        rysujPunkt(300, 30, "red", 8); 

        // --- OBSŁUGA DODAWANIA SZKOŁY ---
        const btnDodaj = document.getElementById('btn-dodaj');
        
        btnDodaj.addEventListener('click', function() {
            
            // Pobieranie
            let idInput = document.getElementById('new_id');
            let xInput = document.getElementById('new_x');
            let yInput = document.getElementById('new_y');
            let pInput = document.getElementById('new_profit');
            let tminInput = document.getElementById('new_tmin'); 
            let tmaxInput = document.getElementById('new_tmax'); 
            let sTimeInput = document.getElementById('service_time');

            // Konwersja
            let currentId = parseInt(idInput.value);
            let x = parseFloat(xInput.value);
            let y = parseFloat(yInput.value);
            let profit = parseFloat(pInput.value);
            let sTime = parseFloat(sTimeInput.value);
            let tmin = czasNaMinuty(tminInput.value);
            let tmax = czasNaMinuty(tmaxInput.value);

            // Walidacja
            if (isNaN(x) || isNaN(y)) { alert("Podaj X i Y!"); return; }
            if (x < 0 || x > 600 || y < 0 || y > 600) { alert("X i Y muszą być 0-600!"); return; }
            if (tmin > tmax) { alert("Koniec okna nie może być przed startem!"); return; }
            if (sTime > (tmax - tmin)) { alert("Za krótkie okno na serwis!"); return; }

            // Obiekt
            let nowaSzkola = {
                id: currentId,
                x: x,
                y: y,
                profit: profit,
                service_time: sTime,
                time_window_start: tmin, 
                time_window_end: tmax,
                display_time: [tminInput.value, tmaxInput.value] // Do tabelki
            };

            // Logika
            listaSzkol.push(nowaSzkola);
            
            // Wizualizacja (Mapa + Tabela)
            rysujPunkt(x, y, "#007bff"); 
            dodajWierszDoTabeli(nowaSzkola);
            
            document.getElementById('licznik_szkol').innerText = "Liczba szkół: " + listaSzkol.length;

            // Sprzątanie
            idInput.value = currentId + 1;
            xInput.value = "";
            yInput.value = "";
            xInput.focus();
        });

const btnRandom = document.getElementById('btn-random');

        // Funkcje pomocnicze muszą być zdefiniowane wcześniej lub tutaj
        function losujLiczbe(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        function minutyNaGodzine(minutyOdStartu) {
            let totalMinuty = minutyOdStartu + MINUTY_STARTU; 
            let h = Math.floor(totalMinuty / 60);
            let m = totalMinuty % 60;
            return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
        }

        if (btnRandom) { // Zabezpieczenie: sprawdź czy przycisk istnieje
            btnRandom.addEventListener('click', function() {
                console.log("Kliknięto generuj losowo"); // Debug w konsoli

                let countInput = document.getElementById('num_generate'); // Zmieniłem ID na zgodne z HTML (num_generate)
                
                // Zabezpieczenie przed pustym inputem
                if (!countInput.value) {
                    alert("Wpisz ilość szkół!");
                    return;
                }

                let ile = parseInt(countInput.value);
                
                let idInput = document.getElementById('new_id');
                let startId = parseInt(idInput.value);

                for (let i = 0; i < ile; i++) {
                    // 1. Losuj współrzędne
                    let x = losujLiczbe(10, MAX_WSPOLRZEDNA - 10); 
                    let y = losujLiczbe(10, MAX_WSPOLRZEDNA - 10);
                    
                    // 2. Losuj Zysk
                    let profit = losujLiczbe(100, 500);

                    // 3. Losuj Okna Czasowe
                    let tmin = losujLiczbe(0, 300); 
                    let tmax = tmin + losujLiczbe(60, 180); 
                    if (tmax > 480) tmax = 480;

                    // 4. Formatowanie
                    let tminStr = minutyNaGodzine(tmin);
                    let tmaxStr = minutyNaGodzine(tmax);

                    let nowaSzkola = {
                        id: startId + i,
                        x: x,
                        y: y,
                        profit: profit,
                        service_time: 20, 
                        time_window_start: tmin,
                        time_window_end: tmax,
                        display_time: [tminStr, tmaxStr]
                    };

                    // Dodaj i narysuj
                    listaSzkol.push(nowaSzkola);
                    
                    // Bezpośrednie wywołanie rysowania - to musi zadziałać
                    rysujPunkt(x, y, "#007bff"); 
                    dodajWierszDoTabeli(nowaSzkola);
                }

                // Aktualizacja UI
                idInput.value = startId + ile;
                document.getElementById('licznik_szkol').innerText = "Liczba szkół: " + listaSzkol.length;
                
                // Wymuś przerysowanie wszystkiego (opcjonalnie, dla pewności)
                // ctx.clearRect(0, 0, ROZMIAR_CANVAS, ROZMIAR_CANVAS);
                // rysujPunkt(300, 30, "red", 8);
                // listaSzkol.forEach(s => rysujPunkt(s.x, s.y, "#007bff"));

                console.log(`Wylosowano ${ile} szkół. Lista:`, listaSzkol);
            });
        } else {
            console.error("Nie znaleziono przycisku btn-random!");
        }
        
        const btnUsun = document.getElementById('btn-usun');
        
        btnUsun.addEventListener('click', function(){
            // 1. POPRAWKA: Pobieramy z dobrego pola (id_delete, a nie new_id)
            let idDeleteInput = document.getElementById('id_delete');
            
            // 2. POPRAWKA: Używamy nazwy idToDelete, żeby pasowała do reszty kodu
            let idToDelete = parseInt(idDeleteInput.value);

            // Walidacja
            if (isNaN(idToDelete)) {
                alert("Podaj ID szkoły do usunięcia!");
                return;
            }

            // Szukamy indeksu
            const index = listaSzkol.findIndex(s => s.id === idToDelete);

            if (index === -1) {
                alert("Nie znaleziono szkoły o ID: " + idToDelete);
                return;
            }

            // Usuwamy szkołę
            listaSzkol.splice(index, 1);

            // Przesuwamy ID w dół dla reszty szkół
            for (let i = index; i < listaSzkol.length; i++) {
                listaSzkol[i].id = listaSzkol[i].id - 1;
            }
            
            // Aktualizujemy licznik dla nowej szkoły (żeby następna dodana miała dobre ID)
            let currentNextId = parseInt(document.getElementById('new_id').value);
            document.getElementById('new_id').value = currentNextId - 1;

            // ODŚWIEŻAMY WIDOK
            ctx.clearRect(0, 0, ROZMIAR_CANVAS, ROZMIAR_CANVAS);
            
            rysujPunkt(300, 30, "red", 8); // Baza

            listaSzkol.forEach(szkola => {
                rysujPunkt(szkola.x, szkola.y, "#007bff");
            });

            // Tabela od nowa
            const tbody = document.getElementById('tabela-szkol').getElementsByTagName('tbody')[0];
            tbody.innerHTML = ""; 
            
            listaSzkol.forEach(szkola => {
                dodajWierszDoTabeli(szkola);
            });

            document.getElementById('licznik_szkol').innerText = "Liczba szkół: " + listaSzkol.length;
            idDeleteInput.value = "";
        });

        // --- OBSŁUGA ZATWIERDZANIA PARAMETRÓW ---
// --- OBSŁUGA ZATWIERDZANIA PARAMETRÓW ---
        const btnZatwierdz = document.getElementById('btn-zatwierdz');
        
        // 1. Dodajemy słowo 'async', żeby móc używać 'await' w środku
        btnZatwierdz.addEventListener('click', async function() {
            
            // --- UX: Zablokuj przycisk, żeby nie klikać 10 razy ---
            btnZatwierdz.disabled = true;
            btnZatwierdz.innerText = "Obliczam trasę... Proszę czekać.";
            document.body.style.cursor = "wait";

            try {
                // A. Zbieramy parametry
                const params = {
                    pop_size: parseInt(document.getElementById('pop_size').value),
                    generations: parseInt(document.getElementById('generations').value),
                    mutation_mode: document.querySelector('input[name="tryb_mutacji"]:checked').value,
                    cross_mode: document.querySelector('input[name="tryb_krzyzowania"]:checked').value,
                    mut_rates: [
                        parseFloat(document.getElementById('mut_rate1').value),
                        parseFloat(document.getElementById('mut_rate2').value),
                        parseFloat(document.getElementById('mut_rate3').value),
                        parseFloat(document.getElementById('mut_rate4').value),
                        1.0
                    ]
                };

                const payload = {
                    parametry: params,
                    szkoly: listaSzkol
                };

                console.log("Wysyłam do Pythona:", payload);

                // B. WYSYŁAMY FETCH (Poprawiona składnia)
                // Upewnij się, że w Pythonie (server.py) masz endpoint '/oblicz-vrp'
                const odpowiedz = await fetch('/oblicz-vrp', { 
                    method: 'POST',  // Dwukropek, nie równa się!
                    headers: {
                        'Content-Type': 'application/json' // Konieczne dla Pythona!
                    },
                    body: JSON.stringify(payload)
                });

                // C. Sprawdzamy błędy HTTP
                if (!odpowiedz.ok) {
                    // Używamy backticków (`), żeby zadziałało ${odpowiedz.status}
                    throw new Error(`Błąd serwera: ${odpowiedz.status}`);
                }

                // D. Odbieramy wynik
                
                const wynik = await odpowiedz.json();
                console.log("Serwer zwrócił: ", wynik);
                
                // 1. Rysujemy trasy na mapie
                if (wynik.routes) {
                    rysujTrasy(wynik.routes);
                }

                // 2. Pokazujemy wykres
                if (wynik.history && wynik.history_best) {
                    pokazWykres(wynik.history, wynik.history_best);
                }
                
                alert("Obliczenia zakończone sukcesem!");

            } catch (blad) {
                console.error("Wystąpił błąd:", blad);
                alert("Wystąpił błąd połączenia z serwerem. Sprawdź konsolę (F12).");
            } finally {
                // --- UX: Odblokuj przycisk niezależnie od wyniku ---
                btnZatwierdz.disabled = false;
                btnZatwierdz.innerText = "Zatwierdź i Oblicz VRP";
                document.body.style.cursor = "default";
            }
        });

    </script>
</body>
</html>